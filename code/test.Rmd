---
title: "Réchauffement cycle 2 test"
author: "Julie Faucher & Laurent Dubroca"
date: "`r date()`"
bibliography: '/home/moi/datahome/work/biblio/enfin/biblioloran.bib'
---


```{r global_options, include=T,cache=F,echo=F,warning=F,message=F,progress=F,verbose=F,results="hide"}
#knitr option
operationnel<-TRUE
knitr::opts_chunk$set(echo=FALSE, 
		      warning=!operationnel, 
		      message=!operationnel,
		      fig.height=8,
		      progress=!operationnel,
		      verbose=!operationnel,
		      include=TRUE,dev='png',autodep=FALSE)
#package
library(COSTcore);library(COSTdbe);library(COSTeda)
library(dplyr);library(tidyr);library(stringr)
library(ggplot2);library(gridExtra)
library(sf)
##library(openxlsx);library(mailR)
library(pander);library(captioner)
library(mapdata)
library(DATRAS)
library(sparkTable)
library(cardidates)
library(lubridate)
#local fct
#source("credo_fct.R")
#initialise les fonctions pour légender tables et figures
tabcap <- captioner(prefix = "Table")
figcap <- captioner(prefix = "Figure")

#`r tabcap(name="info",caption="Stock id: area, species, catches.")`
#```{r,cache=T,eval=!param[1,2],echo=FALSE,results="asis"}
#cat("Empty section with no plot means no data.")
#```
#```{r tsplot1caption,cache=T,eval=tabtest[1,2],echo=FALSE,results="asis"}
#cat(figcap(name="tsarea",caption="Landings by ICES divsion."))
#```
```

# Introduction 

Un test 

```{r data,eval=F}
#test python stuff
library(reticulate)
os<-import("os")
os$listdir(".")
pytest<-c("def add(x,y): 
	  return x+y")
writeLines(pytest,file("pipo.py"))
py_run_string(pytest)
source_python("pipo.py")
add(5,15)

import("cdsapi")
pipopy<-c("import cdsapi
c = cdsapi.Client()
c.retrieve(
'satellite-sst-esa-cci',
{
'variable':'all',
'format':'zip',
'day':'14',
'month':'02',
'year':'2004'
},
'download.zip')
")
writeLines(pipopy,file("pipo.py"))
source_python("pipo.py")




#Copernicus
#download some temperature data

#Emodnet
```

# Data and simulated data

- data : MC
- simulated : not found anything easy to manipulate to mimic phytoplankton time
  series

## Simulation

Not really ready

```{r simu time series,eval=F}
set.seed(666)
#test with a sin
tps <- expand.grid(week=1:51,year=2016:2019)%>%mutate(time=year+week/52)
sp1 <- .5+exp(sin(2*pi*tps$time)) + rnorm(tps$time, sd = 0.1)
plot(tps$time,sp1,type="l")

fct1<-function(x=1:153,maxval=20){
	maxval*sin(2*pi*x/51)+jitter(rep(maxval,length(x)),amount=maxval)#*10/100)
}
plot(fct1(),type="l")
require(gratis)
#simulate a times series
x<-generate_ts(n.ts=1,freq=51,nComp=3,n=51*4)
forecast::autoplot((x$N1$x))
x<-generate_ts_with_target(n=1,ts.length=51*4,freq=51,seasonal=TRUE)
forecast::autoplot((x$N1$x))

x<-generate_msts(seasonal.period=365,n=1200)#n.ts=2,freq=51,nComp=2,n=204)
plot(x)

```

## Marechiara

```{r mc}
mcbio<-read.csv2("./data/MC_bio_2015.csv")%>%
	mutate(date=fast_strptime(date,"%Y-%m-%d",lt=F))#%>%
	#select(-X,-year,-season,-month,-week)
mcenv<-read.csv2("./data/MC_env_2015.csv")
pipo<-gather(mcbio,key="spp",value="abun",7:ncol(mcbio))
listspp<-unique(pipo$spp)
ggplot(pipo%>%filter(spp%in%listspp[1]),aes(x=date,y=abun,color=spp))+
	geom_point()+facet_grid(year~month,scale="free_x")
ggplot(pipo%>%filter(spp%in%listspp[1]),aes(x=date,y=abun,color=spp))+
	geom_point()+
	geom_line()+facet_wrap(~year,scale="free_x")
spp1<-pipo%>%filter(spp%in%listspp[1])


```

## Cheasapeak bay

```{r mc}
chebay<-read.csv("./data/che_bay_bio.csv",sep=";",dec=",")
dim(chebay)
dim(distinct(chebay))
aa<-spread(chebay%>%mutate(newspp=paste(s_name,size,spe_code))%>%
	   select(date,station,layer,newspp,abund,ID),newspp,abund)




```


## Edwards' method

```{r edward}
spp1<-pipo%>%filter(spp%in%listspp[1]&year==2015)
plot(spp1$date,spp1$abun)
#edwards
T=sum(spp1$week*spp1$abun)/sum(spp1$abun)
#all species
edwards<-function(a){sum(a$week*a$abun,na.rm=T)/sum(a$abun,na.rm=T)}
#test on spp1
edwards(spp1)
#using purrr and nest
aa<-pipo%>%group_by(spp,year)%>%tidyr::nest() %>%
	mutate(edwards=purrr::map(data,.f=~edwards(.)))

%>%
	mutate(cdw=purrr::map(fitweibull,.f=~CDW(.))) 

```

## Rolinski methods

Weilbull type function parameters

```{r rolinski}
#test 1 spp 1 year
spp1<-pipo%>%filter(spp%in%listspp[1]&year==2015)
plot(spp1$date,spp1$abun)
rez<-fitweibull6(yday(spp1$date),spp1$abun)
CDW(rez)
plot(rez)
#test 2 species 2 year
spp2<-pipo%>%filter(spp%in%listspp[1:2]&year%in%c(2014:2015))
ggplot(spp2,aes(x=date,y=abun,color=spp))+
	geom_point()+
	geom_line()+facet_wrap(~year,scale="free_x")
#using purrr and nest
aa<-spp2%>%group_by(spp,year)%>%tidyr::nest() %>%
	mutate(fitweibull=purrr::map(data,.f=~fitweibull6(yday(.$date),.$abun))) %>%
	mutate(cdw=purrr::map(fitweibull,.f=~CDW(.))) 
possible_fitweibull6<- purrr::possibly(fitweibull6, otherwise = NA_real_)
possible_CDW<- purrr::possibly(CDW, otherwise = NA_real_)

spp2<-pipo%>%filter(spp%in%listspp[1:2])#&year%in%c(2014:2015))
aa<-pipo%>%group_by(spp,year)%>%tidyr::nest() %>%
	mutate(fitweibull=purrr::map(data,.f=~possible_fitweibull6(yday(.$date),.$abun))) %>%
	mutate(cdw=purrr::map(fitweibull,.f=~possible_CDW(.))) 

saveRDS(aa,file="rezfitwei.RDS")
fct1<-function(a){data.frame(tMid=a$x[1],tBegin=a$x[2],tEnd=a$x[3])}
possible_fct1<-purrr::possibly(fct1,otherwise=data.frame(tMid=NA,tBegin=NA,tEnd=NA))
possible_fct1("oahdoah")
aa1<-aa%>%mutate(rez=purrr::map(cdw,.f=~possible_fct1(.)))
aa2<-aa1%>%tidyr::unnest(rez)

```


```{r spline}
spp1<-pipo%>%filter(spp%in%listspp[1]&year==2015)
plot(yday(spp1$date),spp1$abun)
lines(smooth.spline(yday(spp1$date),spp1$abun,spar=.4))
lines(smooth.spline(yday(spp1$date),spp1$abun,df=10),col="green")
#predict with deriv=1 should work

```

# Time series caracterization


```{r tsfeatures}
require(tsfeatures)
spp1<-pipo%>%filter(spp%in%listspp[2]&year>=1996)
tsspp1<-ts(spp1$abun,freq=51,start=c(min(spp1$year),1))
plot(tsspp1)
tsfeatures(spp1$abun)
	tsfeatures(tsspp1)%>%View()

```

```{r timeseries}
#periodicity bfast
library(bfast)
spp1<-pipo%>%filter(spp%in%listspp[2]&year>=1996)
tsspp1<-ts(spp1$abun,freq=51,start=c(min(spp1$year),1))
plot(tsspp1)
aa<-bfast(tsspp1,h=.05,season="harmonic",max.iter=3)#,hpc="foreach")
plot(aa)



# create two sin-functions
x_orig <- seq(0,1,by=1e-2)
y_orig <- sin(10*2*pi*x_orig) + 0.1*sin(2*2*pi*x_orig)

# make a 10% gap
i <- round(length(x_orig)*0.2) : round(length(x_orig)*0.3)
x <- x_orig
y <- y_orig
x[i] <- NA
y[i] <- NA


# calculating the lomb periodogram
l <- spec.lomb(x = x, y = y,ofac = 20,mode = "normal")

#wavelet/fft
```

```{r testtsfeatures}
library(Rplanktonanalytic)
library(tsfeatures)
library(dplyr)
library(pastecs)
data(phytopknar)
pipo<-phytopknar%>%pull(5)
k<-15
allreg<-regspline(phytopknar$date,as.matrix(phytopknar[,k]))
plot(phytopknar$date,as.data.frame(phytopknar)[,k],type="b")
title(names(phytopknar)[k])
lines(allreg$x,allreg$y,col="red")
lines(phytopknar$date,allreg$y,col="blue")

nbpt<-round(length(unique(year(phytopknar$date)))*365.25/7)
allreg<-regul(as.numeric(phytopknar$date-phytopknar$date[1]),as.matrix(phytopknar[,4:166]),methods="spline",deltat=7,n=nbpt)
which(grepl("Leptocylindrus minimus",names(phytopknar)))
k<-which(grepl("Cryptomonads",names(phytopknar)))
k<-which(grepl("Thalassiosira nordenskioeldii",names(phytopknar)))
plot(as.numeric(phytopknar$date-phytopknar$date[1]),as.data.frame(phytopknar)[,k],type="b")
title(names(phytopknar)[k])
lines(allreg$x,allreg$y[,k-3],col="red")
points(allreg$x,allreg$y[,k-3],col="green")


rez0<-tsfeatures(ts(na.omit(allreg$y)),features=c(entropy,lumpiness,stability,crossing_points,hurst,stl_features,acf_features,pacf_features,nonlinearity,heterogeneity,firstmin_ac,firstzero_ac))
rez0<-data.frame(rez0)[,1:27]

library(ade4)
rezpca<-dudi.pca(data.frame(rez0),nf=6,scannf=FALSE)
s.class(rezpca$li,fac=as.factor(names(allreg$y)))
s.arrow(data.frame(rezpca$c1))#, lab = names(deug$tab), plot = FALSE)


# Bibliography
